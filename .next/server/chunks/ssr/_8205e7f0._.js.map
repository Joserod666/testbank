{"version":3,"sources":["../../../../lib/utils/date-helpers.ts","../../../../lib/supabase/admin.ts","../../../../lib/services/alert-service.ts","../../../../lib/cron/deadline-checker.ts"],"sourcesContent":["export function formatDate(date: string | Date): string {\n\tconst d = new Date(date)\n\treturn d.toLocaleDateString(\"es-ES\", {\n\t\tyear: \"numeric\",\n\t\tmonth: \"short\",\n\t\tday: \"numeric\",\n\t})\n}\n\nexport function formatDateTime(date: string | Date): string {\n\tconst d = new Date(date)\n\treturn d.toLocaleDateString(\"es-ES\", {\n\t\tyear: \"numeric\",\n\t\tmonth: \"short\",\n\t\tday: \"numeric\",\n\t\thour: \"2-digit\",\n\t\tminute: \"2-digit\",\n\t})\n}\n\nexport function getDaysUntil(date: string | Date): number {\n\tconst today = new Date()\n\ttoday.setHours(0, 0, 0, 0)\n\tconst target = new Date(date)\n\ttarget.setHours(0, 0, 0, 0)\n\tconst diff = target.getTime() - today.getTime()\n\treturn Math.ceil(diff / (1000 * 60 * 60 * 24))\n}\n\nexport function getHoursUntil(date: string | Date): number {\n\tconst now = new Date()\n\tconst target = new Date(date)\n\tconst diff = target.getTime() - now.getTime()\n\treturn Math.ceil(diff / (1000 * 60 * 60))\n}\n\nexport function getTimeUntilFormatted(date: string | Date): string {\n\tconst hoursUntil = getHoursUntil(date)\n\tconst daysUntil = getDaysUntil(date)\n\n\tif (hoursUntil < 0) {\n\t\tconst absHours = Math.abs(hoursUntil)\n\t\tconst absDays = Math.floor(absHours / 24)\n\t\treturn `${absDays} d√≠a${absDays !== 1 ? \"s\" : \"\"} y ${absHours % 24} hora${absHours % 24 !== 1 ? \"s\" : \"\"} atrasado`\n\t}\n\n\tif (hoursUntil < 24) {\n\t\treturn `${hoursUntil} hora${hoursUntil !== 1 ? \"s\" : \"\"}`\n\t}\n\n\tconst days = Math.floor(hoursUntil / 24)\n\tconst hours = hoursUntil % 24\n\n\tif (hours === 0) {\n\t\treturn `${days} d√≠a${days !== 1 ? \"s\" : \"\"}`\n\t}\n\n\treturn `${days} d√≠a${days !== 1 ? \"s\" : \"\"} y ${hours} hora${hours !== 1 ? \"s\" : \"\"}`\n}\n\nexport function isWithin7Days(date: string | Date): boolean {\n\tconst hoursUntil = getHoursUntil(date)\n\treturn hoursUntil >= 0 && hoursUntil <= 7 * 24\n}\n\nexport function isOverdue(date: string | Date): boolean {\n  return getDaysUntil(date) < 0\n}\n\nexport function isUpcoming(date: string | Date, days = 7): boolean {\n  const daysUntil = getDaysUntil(date)\n  return daysUntil >= 0 && daysUntil <= days\n}\n\nexport function getDateStatus(date: string | Date): \"overdue\" | \"urgent\" | \"upcoming\" | \"normal\" {\n  const daysUntil = getDaysUntil(date)\n  if (daysUntil < 0) return \"overdue\"\n  if (daysUntil <= 3) return \"urgent\"\n  if (daysUntil <= 7) return \"upcoming\"\n  return \"normal\"\n}\n","/**\r\n * Cliente de Supabase para operaciones administrativas\r\n * No requiere cookies ni autenticaci√≥n de usuario\r\n * √ötil para tareas en segundo plano como verificaciones de deadlines\r\n */\r\nimport { createClient } from \"@supabase/supabase-js\"\r\n\r\nexport function createAdminClient() {\r\n\tconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\r\n\tconst supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\r\n\r\n\tif (!supabaseUrl || !supabaseKey) {\r\n\t\tthrow new Error(\"NEXT_PUBLIC_SUPABASE_URL y NEXT_PUBLIC_SUPABASE_ANON_KEY deben estar configurados\")\r\n\t}\r\n\r\n\treturn createClient(supabaseUrl, supabaseKey)\r\n}\r\n\r\n","import { createAdminClient } from \"@/lib/supabase/admin\"\r\nimport type { Project } from \"@/lib/types\"\r\nimport { getHoursUntil, formatDate, getTimeUntilFormatted } from \"@/lib/utils/date-helpers\"\r\n\r\ninterface AlertProject extends Project {\r\n\tclients: {\r\n\t\tname: string\r\n\t\temail: string | null\r\n\t}\r\n}\r\n\r\n/**\r\n * Verifica proyectos que vencen en 3 d√≠as o menos\r\n */\r\nexport async function checkUpcomingDeadlines() {\r\n\tconst supabase = createAdminClient()\r\n\r\n\tconst { data: projects } = await supabase\r\n\t\t.from(\"projects\")\r\n\t\t.select(\"*, clients(name, email)\")\r\n\t\t.in(\"status\", [\"pending\", \"in_progress\", \"delayed\"])\r\n\t\t.order(\"due_date\", { ascending: true })\r\n\r\n\tif (!projects || projects.length === 0) {\r\n\t\treturn []\r\n\t}\r\n\r\n\tconst urgentProjects: AlertProject[] = []\r\n\r\n\tprojects.forEach((project: AlertProject) => {\r\n\t\tconst hoursUntil = getHoursUntil(project.due_date)\r\n\t\t// Proyectos que vencen en 3 d√≠as (72 horas) o menos\r\n\t\tif (hoursUntil >= 0 && hoursUntil <= 72) {\r\n\t\t\turgentProjects.push(project)\r\n\t\t}\r\n\t})\r\n\r\n\treturn urgentProjects\r\n}\r\n\r\n/**\r\n * Env√≠a alerta por consola (simulado)\r\n */\r\nexport function sendConsoleAlert(project: AlertProject) {\r\n\tconst hoursUntil = getHoursUntil(project.due_date)\r\n\tconst timeUntil = getTimeUntilFormatted(project.due_date)\r\n\r\n\tconsole.log(\"=\".repeat(80))\r\n\tconsole.log(\"üö® ALERTA: Proyecto pr√≥ximo a vencer\")\r\n\tconsole.log(\"=\".repeat(80))\r\n\tconsole.log(`Proyecto: ${project.name}`)\r\n\tconsole.log(`Cliente: ${project.clients.name}`)\r\n\tconsole.log(`Fecha de vencimiento: ${formatDate(project.due_date)}`)\r\n\tconsole.log(`Tiempo restante: ${timeUntil}`)\r\n\tconsole.log(`Horas restantes: ${hoursUntil} horas`)\r\n\tconsole.log(`Estado: ${project.status}`)\r\n\tconsole.log(`Progreso: ${project.completion_percentage}%`)\r\n\tconsole.log(\"=\".repeat(80))\r\n}\r\n\r\n/**\r\n * Env√≠a alerta por email usando Resend (real)\r\n */\r\nexport async function sendEmailAlert(project: AlertProject) {\r\n\tconst hoursUntil = getHoursUntil(project.due_date)\r\n\tconst timeUntil = getTimeUntilFormatted(project.due_date)\r\n\r\n\t// Verificar que Resend est√© configurado\r\n\tconst resendApiKey = process.env.RESEND_API_KEY\r\n\tconst fromEmail = process.env.RESEND_FROM_EMAIL || \"noreply@example.com\"\r\n\r\n\tif (!resendApiKey) {\r\n\t\tconsole.warn(\"‚ö†Ô∏è RESEND_API_KEY no configurada. Saltando env√≠o de email real.\")\r\n\t\treturn { success: false, error: \"RESEND_API_KEY no configurada\" }\r\n\t}\r\n\r\n\ttry {\r\n\t\t// Importar Resend din√°micamente\r\n\t\tconst resendModule = await import(\"resend\")\r\n\t\tconst Resend = resendModule.Resend || (resendModule as any).default?.Resend || (resendModule as any).default\r\n\t\t\r\n\t\tif (!Resend) {\r\n\t\t\tthrow new Error(\"No se pudo importar Resend correctamente\")\r\n\t\t}\r\n\t\t\r\n\t\tconst resend = new Resend(resendApiKey)\r\n\r\n\t\tconst emailContent = `\r\n\t\t\t<h2>üö® Alerta: Proyecto pr√≥ximo a vencer</h2>\r\n\t\t\t<p>El siguiente proyecto est√° pr√≥ximo a vencer:</p>\r\n\t\t\t<ul>\r\n\t\t\t\t<li><strong>Proyecto:</strong> ${project.name}</li>\r\n\t\t\t\t<li><strong>Cliente:</strong> ${project.clients.name}</li>\r\n\t\t\t\t<li><strong>Fecha de vencimiento:</strong> ${formatDate(project.due_date)}</li>\r\n\t\t\t\t<li><strong>Tiempo restante:</strong> ${timeUntil}</li>\r\n\t\t\t\t<li><strong>Horas restantes:</strong> ${hoursUntil} horas</li>\r\n\t\t\t\t<li><strong>Estado:</strong> ${project.status}</li>\r\n\t\t\t\t<li><strong>Progreso:</strong> ${project.completion_percentage}%</li>\r\n\t\t\t</ul>\r\n\t\t\t<p>Por favor, revisa el proyecto y toma las acciones necesarias.</p>\r\n\t\t`\r\n\r\n\t\t// Obtener email del cliente o usar email por defecto\r\n\t\tconst toEmail = project.clients.email || process.env.ALERT_DEFAULT_EMAIL || \"admin@example.com\"\r\n\r\n\t\tconst { data, error } = await resend.emails.send({\r\n\t\t\tfrom: fromEmail,\r\n\t\t\tto: [toEmail],\r\n\t\t\tsubject: `üö® Alerta: ${project.name} vence en ${timeUntil}`,\r\n\t\t\thtml: emailContent,\r\n\t\t})\r\n\r\n\t\tif (error) {\r\n\t\t\tconsole.error(\"‚ùå Error al enviar email:\", error)\r\n\t\t\treturn { success: false, error }\r\n\t\t}\r\n\r\n\t\tconsole.log(\"‚úÖ Email enviado exitosamente:\", data)\r\n\t\treturn { success: true, data }\r\n\t} catch (error) {\r\n\t\tconsole.error(\"‚ùå Error al inicializar Resend:\", error)\r\n\t\treturn { success: false, error }\r\n\t}\r\n}\r\n\r\n/**\r\n * Procesa todas las alertas (consola + email)\r\n */\r\nexport async function processAlerts() {\r\n\tconsole.log(\"\\nüîç Verificando proyectos pr√≥ximos a vencer...\")\r\n\tconst urgentProjects = await checkUpcomingDeadlines()\r\n\r\n\tif (urgentProjects.length === 0) {\r\n\t\tconsole.log(\"‚úÖ No hay proyectos pr√≥ximos a vencer (3 d√≠as o menos)\")\r\n\t\treturn { count: 0, alerts: [] }\r\n\t}\r\n\r\n\tconsole.log(`‚ö†Ô∏è Se encontraron ${urgentProjects.length} proyecto(s) pr√≥ximo(s) a vencer\\n`)\r\n\r\n\tconst alerts = []\r\n\r\n\tfor (const project of urgentProjects) {\r\n\t\t// Enviar alerta por consola (simulado) - SIEMPRE se ejecuta\r\n\t\tsendConsoleAlert(project)\r\n\r\n\t\t// Enviar alerta por email (real) - SIEMPRE se ejecuta si est√° configurado\r\n\t\tconst emailResult = await sendEmailAlert(project)\r\n\t\talerts.push({\r\n\t\t\tproject: project.name,\r\n\t\t\tconsole: true,\r\n\t\t\temail: emailResult.success,\r\n\t\t\temailError: emailResult.error,\r\n\t\t})\r\n\t}\r\n\r\n\treturn { count: urgentProjects.length, alerts }\r\n}\r\n\r\n","import { processAlerts } from \"@/lib/services/alert-service\"\r\n\r\n/**\r\n * Funci√≥n que se ejecuta peri√≥dicamente para verificar proyectos pr√≥ximos a vencer\r\n * Esta funci√≥n puede ser llamada desde un cron job o al iniciar el servidor\r\n */\r\nexport async function runDeadlineChecker() {\r\n\ttry {\r\n\t\tconst result = await processAlerts()\r\n\t\treturn result\r\n\t} catch (error) {\r\n\t\tconsole.error(\"‚ùå Error en deadline checker:\", error)\r\n\t\treturn { count: 0, alerts: [], error }\r\n\t}\r\n}\r\n\r\n/**\r\n * Ejecuta la verificaci√≥n cada X minutos\r\n * En producci√≥n, esto deber√≠a ejecutarse mediante un cron job externo o Vercel Cron\r\n */\r\nexport function startDeadlineChecker(intervalMinutes: number = 60) {\r\n\tconsole.log(`‚è∞ Iniciando verificador de deadlines cada ${intervalMinutes} minutos`)\r\n\r\n\t// Ejecutar inmediatamente al iniciar\r\n\trunDeadlineChecker()\r\n\r\n\t// Ejecutar peri√≥dicamente\r\n\tconst intervalMs = intervalMinutes * 60 * 1000\r\n\tsetInterval(() => {\r\n\t\trunDeadlineChecker()\r\n\t}, intervalMs)\r\n}\r\n\r\n"],"names":[],"mappings":"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"}